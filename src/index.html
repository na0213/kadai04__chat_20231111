<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="./vendor/tailwind/tailwind.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<header>

</header>
<body>
    <p class="text-2xl mt-5 mb-10 text-center"><span class="first-p">P</span>OJI<span class="second-p">P</span>OJI <span class="first-c">C</span>HAT</p>
    <!-- コンテンツ表示画面 -->
    <div class="container">
        <div class="side">
          <ul>
            <li class="mt-3 ml-3 mb-3">
                <a id="friends" href="index.html">FRIENDS</a>
            </li>
            <li class="mt-3 ml-3 mb-3">
                <a id="pets" href="pet.html">PET</a>
            </li>
            <li class="mt-3 ml-3 mb-3">
                <a id="storage" href="storage.html">保存</a>
            </li>
          </ul>
        </div>

        <div class="chat_body">
            <!-- <div class="name_list">
                    <input type="text" class="name_a">
                    <input type="text" class="name_b">
            </div> -->
            
            <div id="output">
                <div id="myModal" class="modal">
                    <div class="modal-content">
                      <span class="close">&times;</span>
                      <p id="modalText" class="modal_text">
                        <ul class="modal-w">
                            <a href="#" class="storage">保存</a>
                            <a href="#" class="delete">削除</a>
                            <!-- <li class="storage">保存</li>
                            <li class="delete">削除</li> -->
                        </ul>
                      </p>
                    </div>
                </div>
            </div>

            <div class="message">
                <div class="partner"></div>
                <div class="me"></div>
            </div>

            <div class="send_message">
                <div class="send_icon">
                    <a href="#" id="rsend" class="btn-social-circle btn-social-circle--twitter">
                        <i class="fa-regular fa-paper-plane"></i>
                        <input id="rname" style="display: none;">
                    </a>
                </div>
                <div class="send_text">
                    <textarea id="rtext" placeholder="文章を入力してください"></textarea>
                </div>
                <div class="send_text">
                    <textarea id="text" placeholder="文章を入力してください"></textarea>
                </div>
                <div class="send_icon">
                    <a href="#" id="send" class="btn-social-circle btn-social-circle--twitter">
                        <i class="fa-regular fa-paper-plane"></i>
                        <input id="uname" style="display: none;">
                    </a>
                </div>
            </div>

        </div>
        
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved }
            from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: env('FIREBASE_API_KEY'),
            authDomain:  env('FIREBASE_AUTH_DOMAIN'),
            databaseURL: env('FIREBASE_DATABASE_URL'),
            projectId: env('FIREBASE_PROJECT_ID'),
            storageBucket: env('FIREBASE_STORAGE_BUCKET'),
            messagingSenderId: env('FIREBASE_MESSAGING_SENDER_ID'),
            appId: env('FIREBASE_APP_ID'),
        };
        const app = initializeApp(firebaseConfig); //鍵を開ける
        const db = getDatabase(app); //RealtimeDBに接続
        const dbRef = ref(db, "chat"); //RealtimeDB内の"chat"を使う　”natus"でもよい

        //ユーザー側
        $('#send').on('click', function(){
            const uname = $('#uname').val();
            const text = $('#text').val();
            // const date = $('#date').val();

            // console.log(uname, 'unameの文字')
            // console.log(text, 'textの文字')

            // firebaseにデータを送る
            const msg = {
                uname: uname,  //普通は、uname: uname,
                text: text,  //普通は、text: text,と書いて、わかりやすいようにする
                // date: date,
            }

            // firebaseにデータを送る処理
            // pushはfirebase が用意したおまじない
            const newPostRef = push(dbRef); //firebase公式の書き方 JSとは違う
            // setはfirebase が用意したおまじない
            set(newPostRef, msg);


            // 送信を押したら入力された文字を消す
            $('#uname').val("");
            $('#text').val("");
        })

        //レスポンス側
        $('#rsend').on('click', function(){
            const rname = $('#rname').val();
            const rtext = $('#rtext').val();
            // const date = $('#date').val();

            // console.log(rname, 'rnameの文字')
            // console.log(text, 'rtextの文字')

            // firebaseにデータを送る
            const msg = {
                rname: rname,  //普通は、uname: uname,
                rtext: rtext,  //普通は、text: text,と書いて、わかりやすいようにする
                // date: date,
            }

            // firebaseにデータを送る処理
            // pushはfirebase が用意したおまじない
            const newPostRef = push(dbRef); //firebase公式の書き方 JSとは違う
            // setはfirebase が用意したおまじない
            set(newPostRef, msg);


            // 送信を押したら入力された文字を消す
            $('#rname').val("");
            $('#rtext').val("");
        })

        //データ登録(Enter)
        function applyTextTransformations(text) {
            if (text) {
                return text
                    .replace(/疲れた/g, 'ベホイミ')
                    .replace(/無理/g, '諦めたらそこで試合終了ですよ')
                    .replace(/うざ/g, '存在感すご');
            } else {
                return ''; // textがundefinedの場合、空の文字列を返す
            }
        }

        onChildAdded(dbRef, function(data) { 
            const msg = data.val();
            const key = data.key;

            // console.log(key);
            const retext = applyTextTransformations(msg.text);
            const rerText = applyTextTransformations(msg.rtext);

            if(retext !== '') {
                let html = `
                <div class="b-right-wrapper message">
                    <div class="b-right">
                    <div class=${key}>
                        <p class="user">${msg.uname}</p>
                        <p class="user">${retext}</p>
                    </div>
                    </div>
                </div>
                `
                $('#output').append(html);
            }
            if(rerText !== '') {
                let html = `
                <div class="b-left-wrapper message">
                    <div class="b-left">
                    <div class=${key}>
                        <p class="response">${msg.rname}</p>
                        <p class="response">${rerText}</p>
                    </div>
                    </div>
                </div>
            `

            $('#output').append(html);
            }

        });

        var modal = document.getElementById("myModal");
        var span = document.getElementsByClassName("close")[0];

        span.onclick = function() {
        modal.style.display = "none";
        }

        window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
        }

        // メッセージがクリックされたときにモーダルを表示する
        $(document).on('click', '.message', function() {
        var text = $(this).text(); // メッセージのテキストを取得
        $('#modalText').text(text); // モーダルウィンドウのテキストを更新
        modal.style.display = "block"; // モーダルウィンドウを表示
        });

        $(document).on('click', '.storage', function() {
            const messageText = $('#modalText').text(); //モーダルに表示されているテキストを取得
            // console.log(messageText);
            const savedMessages = JSON.parse(localStorage.getItem('savedMessages')) || [];  //ローカルストレージから既存のメッセージ配列を取得

            savedMessages.push(messageText); //新しいメッセージを配列に追加

            localStorage.setItem('savedMessages', JSON.stringify(savedMessages));  //更新された配列をローカルストレージに保存
        });
        
        //最初にデータ取得＆onSnapshotでリアルタイムにデータを取得
        // onChildAdded(dbRef, function(data) { //成功したらdataにデータが入る onChildAddedはfirebaseのもの、JSではない
        //     const msg = data.val();
        //     console.log(msg);
        //     const key = data.key;

        //     console.log(msg.text);
        //     console.log(msg.rtext);

        //     const retext = msg.text
        //         .replace(/疲れた/g,'ベホイミ')
        //         .replace(/無理じゃない？/g,'諦めたらそこで試合終了ですよ')
        //         .replace(/うざ/g,'存在感すご')
            
        //     let html = `
        //     <div class=${key}>
        //         <p>${msg.uname}</p>
        //         <p>${retext}</p>
        //     </div>
        //     <div class=${key}>
        //         <p>${msg.rname}</p>
        //         <p>${msg.rtext}</p>
        //     </div>
        //     `

        //     $('#output').append(html)
        // })


    </script>

</body>
</html>